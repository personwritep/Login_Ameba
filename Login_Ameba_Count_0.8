// ==UserScript==
// @name         Login Ameba Count + AD Check
// @namespace    http://tampermonkey.net/
// @version      0.8
// @description  ãƒ–ãƒ­ã‚°ãƒšãƒ¼ã‚¸ã§ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ã‚¢ã‚¦ãƒˆçŠ¶æ³ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ï¼‹ADãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¦³æ¸¬
// @author       Ameba Blog User
// @match        https://ameblo.jp/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=ameblo.jp
// @noframes
// @grant        none
// ==/UserScript==



let target=document.querySelector('head > title');
let monitor=new MutationObserver(main);
monitor.observe(target, { childList: true });

main();

function main(){

    let yy_pos=sessionStorage.getItem('LA_pos');
    if(yy_pos>0){
        window.scrollTo(0, yy_pos); // ã“ã®ãƒ„ãƒ¼ãƒ«ã®ãƒªãƒ­ãƒ¼ãƒ‰ç›´å‰ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’è¡¨ç¤º
        sessionStorage.setItem('LA_pos', 0); }


    let retry=0;
    let interval=setInterval(wait_target, 500);
    function wait_target(){
        retry++;

        if(retry<2 ){ // .5secã§å‹•ä½œ
            clear_disp(); }
        if(1<retry && retry<5 ){ // 1secï½2sec ã§å‹•ä½œ
            ad_check(); }
        if(4<retry){ // 2.5sec ã§ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒã‚§ãƒƒã‚¯
            check_login();
            clearInterval(interval); }}



    function clear_disp(){
        let topics=document.querySelector('._TiKJItsG');
        if(topics){
            topics.style.background="#fff";
            if(topics.querySelector('#lac')){
                topics.querySelector('#lac').remove(); }}}



    function ad_check(){
        let b_ad=document.querySelector('#rise-interstitial-area');
        let topics=document.querySelector('._TiKJItsG');
        if(topics){

            /*
            let ye='<span class="ye">ğŸŸ¡</span>'
            topics.insertAdjacentHTML('afterbegin', ye);
            setTimeout(()=>{
                if(topics.querySelector('.ye')){
                   topics.querySelector('.ye').remove(); }
            },200);
           */

            if(b_ad){
                let disp=0; // å®Ÿéš›ã«ADè¡¨ç¤ºã€Œ1ã€
                topics.style.background="#eee";
                let style=window.getComputedStyle(b_ad);
                if(style){
                    let value=style.getPropertyValue('visibility');
                    if(value!="hidden"){
                        disp=1; }}
                else{
                    disp=1; }
                if(disp==1){
                    topics.style.background="#ffcc00"; }}
            else{
                topics.style.background="#fff"; }}

    } // ad_check()



    function check_login(){
        let LAC=get_cookie('LAC_count');
        if(LAC!=0){
            let LAC_data=LAC.split('ã€€');

            let login_user=document.querySelector('._3qMawLFY');
            if(login_user){ // ãƒ­ã‚°ã‚¤ãƒ³ã‚’ç¢ºèª
                LAC_data[0]=LAC_data[0]/1+1;
                LAC=LAC_data[0]+'ã€€'+LAC_data[1];
                document.cookie='LAC_count='+ LAC +'; path=/; Max-Age=604800'; } // 7æ—¥
            else{ // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚’ç¢ºèª
                LAC_data[1]=LAC_data[1]/1+1;
                LAC=LAC_data[0]+'ã€€'+LAC_data[1];
                document.cookie='LAC_count='+ LAC +'; path=/; Max-Age=604800'; // 7æ—¥
                if(location.hash!='#cbox'){ // #cboxä»˜ãURLã§é–‹ã„ãŸå ´åˆã¯ ãƒ­ã‚°ã‚¤ãƒ³æ“ä½œã‚’ã—ãªã„
                    let y_pos=document.documentElement.scrollTop
                    sessionStorage.setItem('LA_pos', y_pos); // ç¾åœ¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’è¨˜éŒ²

                    let sw=document.querySelector('._Ja750p9p > a');
                    if(sw){
                        sw.click(); } // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ï¼ˆçµæœã¯ãƒªãƒ­ãƒ¼ãƒ‰ï¼‰
                }}
        } // if(LAC!=0)


        let topics=document.querySelector('._TiKJItsG');
        if(topics){ //ã€Œ*ï¸âƒ£ã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            let sw=
                '<div id="lac">*ï¸âƒ£'+
                '<style>'+
                '#lac { position: relative; font-size: 27px; line-height: 38px; '+
                'margin: 3px 20px 0 0; user-select: none; } '+
                '._20HBv-D7 { pointer-events: none; }</style></div>';
            if(!topics.querySelector('#lac')){
                topics.insertAdjacentHTML('afterbegin', sw); }

            let lac=topics.querySelector('#lac');
            if(lac){
                lac.onclick=(event)=>{
                    event.preventDefault();
                    event.stopImmediatePropagation();
                    disp_panel();
                }}
        } // if(topics)

    } // check_login()



    function get_cookie(name){
        let cookie_req=document.cookie.split('; ').find(row=>row.startsWith(name));
        if(cookie_req){
            if(cookie_req.split('=')[1]==null){
                return 0; }
            else{
                return cookie_req.split('=')[1]; }}
        if(!cookie_req){
            return 0; }}



    function disp_panel(){
        let disp=
            '<div id="lac_disp"><span>ã€€</span><button id="lac_reset">Reset</button>'+
            '<style>'+
            '#lac_disp { position: absolute; top: -3px; left: 50px; z-index: calc(infinity); '+
            'font: normal 16px Meiryo; width: 240px; padding: 8px 12px 6px; text-align: left; '+
            'overflow: hidden; border: 1px solid #009688; background: #fff; '+
            'box-shadow: 2px 2px 6px #00000050; } '+
            '#lac_reset { position: absolute; right: 12px; top: 4px; font-size: inherit; '+
            '-webkit-appearance: button; padding: 8px 6px 6px; line-height: 12px; border: revert; }'+
            '</style></div>';

        let lac=document.querySelector('#lac');
        let lac_disp=document.querySelector('#lac_disp');
        if(lac && !lac_disp){
            lac.insertAdjacentHTML('beforeend', disp); }
        else if(lac && lac_disp){
            lac_disp.remove(); }


        let lac_disp_s=document.querySelector('#lac_disp span');
        let LAC_after=get_cookie('LAC_count');
        if(LAC_after && lac_disp_s){
            let LAC_data=LAC_after.split('ã€€');
            lac_disp_s.textContent="in: "+ LAC_data[0] +"ã€€out: "+ LAC_data[1]; }


        let lac_reset=document.querySelector('#lac_reset');
        if(lac_reset){
            lac_reset.onclick=()=>{
                let LAC='0ã€€0'; //ã€ŒLoginã€€Logoutã€
                document.cookie='LAC_count='+ LAC +'; path=/; Max-Age=604800'; }} // 7æ—¥

    } // disp_panel()

} // main()

